name: Test Kubernetes deployment
on:
  pull_request:
  push:
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run kustomize build
        run: |
          make .env
          kustomize build .
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        BUILD_CASE:
          - default
    env:
      CLUSTER_NAME: kind
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
      - name: Prepare environment
        run: |
          make .env
          cat .github/test-matrix/${{ matrix.BUILD_CASE }}.env >> .env
      - name: Output environment
        run: cat .env
      - name: Pull and build images
        run: |
          export BUILDX_BUILDER=${{ steps.buildx.outputs.name }}
          make build
      - name: Use kubectl context
        run: |
          kind get clusters
          kubectl config use-context kind-${{ env.CLUSTER_NAME }}
      - name: Import images to Kind
        run: |
          kind load docker-image jeboehm/mailserver-mda:latest
          kind load docker-image jeboehm/mailserver-mta:latest
          kind load docker-image jeboehm/mailserver-filter:latest
          kind load docker-image jeboehm/mailserver-web:latest
          kind load docker-image jeboehm/mailserver-unbound:latest
      - name: Deploy Kubernetes resources
        run: |
          kubectl apply -k .
      - name: Check if all resources are deployed
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=docker-mailserver
